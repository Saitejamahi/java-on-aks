trigger:
- master

variables:
  CONTAINER_REGISTRY: 'javademosregistry'
  IMAGE_TAG: '$(Build.BuildId)'

stages:
- stage: Build
  displayName: Build Stage
  jobs:
  - job: Build
    displayName: Build & Push Image
    pool:
      name: self-hosted-pool2

    steps:
    # Step 1: Echo Agent Info
    - script: |
        echo "Running on agent: %AGENT_NAME%"
        echo "Build ID: $(Build.BuildId)"
      displayName: Agent Info

    # Step 2: Login to Azure and ACR
    - task: AzureCLI@2
      displayName: Login to Azure & ACR
      inputs:
        azureSubscription: 'ACR_Docker_Connection'  # Replace with your AzureRM service connection
        scriptType: 'ps'  # PowerShell
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Logging in to Azure..."
          az acr login -n $(CONTAINER_REGISTRY)
    
    # Step 3: Build Docker Image with Maven + Jib
    - script: |
        echo "Building Docker image with Maven + Jib..."
        mvn compile jib:build -Djib.to.image=$(CONTAINER_REGISTRY).azurecr.io/demo:$(IMAGE_TAG)
      displayName: Build with Maven + Jib
    - task: Docker@2
      inputs:
        containerRegistry: 'ACR_Docker_Connection'
        command: 'buildAndPush'
        Dockerfile: '**/Dockerfile'
        displayName: Build and Push Docker Image
   
